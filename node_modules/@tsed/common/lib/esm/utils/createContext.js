import { PlatformContext } from "../domain/PlatformContext.js";
import { PlatformRequest } from "../services/PlatformRequest.js";
import { PlatformResponse } from "../services/PlatformResponse.js";
import { v4 } from "uuid";
const defaultReqIdBuilder = (req) => req.get("x-request-id") || v4().replace(/-/gi, "");
/**
 * Create the TsED context to wrap request, response, injector, etc...
 * @param injector
 * @ignore
 */
export function createContext(injector) {
    var _a, _b;
    const ResponseKlass = (_a = injector.getProvider(PlatformResponse)) === null || _a === void 0 ? void 0 : _a.useClass;
    const RequestKlass = (_b = injector.getProvider(PlatformRequest)) === null || _b === void 0 ? void 0 : _b.useClass;
    const { reqIdBuilder = defaultReqIdBuilder, ...loggerOptions } = injector.settings.logger || {};
    return async (event) => {
        const ctx = new PlatformContext({
            event,
            id: reqIdBuilder(event.request),
            logger: injector.logger,
            ...loggerOptions,
            injector,
            ResponseKlass,
            RequestKlass
        });
        ctx.response.onEnd(async () => {
            await ctx.emit("$onResponse", ctx);
            await ctx.destroy();
        });
        await ctx.emit("$onRequest", ctx);
        return ctx;
    };
}
//# sourceMappingURL=createContext.js.map