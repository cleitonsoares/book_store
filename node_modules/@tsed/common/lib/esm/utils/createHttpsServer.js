import { ProviderScope } from "@tsed/di";
import { getHostInfoFromPort } from "@tsed/core";
import Https from "https";
import { HttpsServer } from "../decorators/httpsServer.js";
import { listenServer } from "./listenServer.js";
export function createHttpsServer(injector, requestListener) {
    const { settings } = injector;
    const httpsPort = settings.getRaw("httpsPort");
    const httpsOptions = settings.getRaw("httpsOptions");
    const server = httpsPort !== false ? Https.createServer(httpsOptions, requestListener) : null;
    injector.addProvider(HttpsServer, {
        scope: ProviderScope.SINGLETON,
        useValue: server
    });
    injector.addProvider(Https.Server, {
        scope: ProviderScope.SINGLETON,
        useValue: server
    });
    injector.invoke(HttpsServer);
    injector.invoke(Https.Server);
    if (server) {
        const hostInfo = getHostInfoFromPort("https", httpsPort);
        return async () => {
            const resolvedHostInfo = await listenServer(injector, server, hostInfo);
            settings.setRaw("httpsPort", `${resolvedHostInfo.address}:${resolvedHostInfo.port}`);
            return server;
        };
    }
}
//# sourceMappingURL=createHttpsServer.js.map