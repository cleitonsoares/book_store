{"version":3,"file":"authOptions.js","sourceRoot":"","sources":["../../../src/decorators/authOptions.ts"],"names":[],"mappings":"AAAA,OAAO,EACL,iBAAiB,EAGjB,eAAe,EACf,cAAc,EAEd,wBAAwB,EACzB,MAAM,YAAY,CAAC;AACpB,OAAO,EAAC,YAAY,EAAC,MAAM,cAAc,CAAC;AAyB1C;;;;;;;;;;;;;;;;;;;;GAoBG;AACH,MAAM,UAAU,WAAW,CAAC,SAAoB,EAAE,UAAwB,EAAE;IAC1E,OAAO,CAAI,GAAG,IAAyB,EAAqC,EAAE;QAC5E,QAAQ,eAAe,CAAC,IAAI,CAAC,EAAE;YAC7B,KAAK,cAAc,CAAC,MAAM;gBACxB,OAAO,YAAY,CAAC,CAAC,MAAM,EAAE,EAAE;oBAC7B,MAAM,KAAK,GAAG,MAAM,CAAC,KAAK,CAAC;oBAE3B,IAAI,OAAO,CAAC,SAAS,EAAE;wBACrB,MAAM,EAAC,SAAS,EAAC,GAAG,OAAO,CAAC;wBAC5B,KAAK,CAAC,KAAK,CAAC,WAAW,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC;wBAC1C,OAAO,OAAO,CAAC,SAAS,CAAC;qBAC1B;oBAED,IAAI,OAAO,CAAC,QAAQ,EAAE;wBACpB,MAAM,EAAC,QAAQ,EAAC,GAAG,OAAO,CAAC;wBAC3B,EAAE,CAAC,MAAM,CAAC,QAAe,CAAC,CAAC,OAAO,CAAC,CAAC,QAAQ,EAAE,EAAE;4BAC9C,MAAM,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,EAAE,MAAM,CAAqB,EAAE,EAAE;gCACtE,MAAM,CAAC,SAAU,CAAC,iBAAiB,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;4BACpD,CAAC,CAAC,CAAC;wBACL,CAAC,CAAC,CAAC;wBAEH,OAAO,OAAO,CAAC,QAAQ,CAAC;qBACzB;oBAED,KAAK,CAAC,KAAK,CAAC,SAAS,EAAE,OAAO,EAAE,IAAI,CAAC,CAAC;gBACxC,CAAC,CAAC,CAAC,GAAI,IAAkC,CAAC,CAAC;YAE7C,KAAK,cAAc,CAAC,KAAK;gBACvB,iBAAiB,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,WAAW,CAAC,SAAS,EAAE,OAAO,CAAC,CAAC,CAAC;gBAC5D,MAAM;YAER;gBACE,MAAM,IAAI,wBAAwB,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;SACzD;IACH,CAAC,CAAC;AACJ,CAAC","sourcesContent":["import {\n  decorateMethodsOf,\n  DecoratorMethodParameters,\n  DecoratorParameters,\n  decoratorTypeOf,\n  DecoratorTypes,\n  Type,\n  UnsupportedDecoratorType\n} from \"@tsed/core\";\nimport {JsonEntityFn} from \"@tsed/schema\";\n\nexport interface IAuthOptions {\n  /**\n   * @deprecated Since v6. Use @Returns from @tsed/schema\n   */\n  responses?: {\n    [statusCode: string]: {\n      description: string;\n    };\n  };\n  /**\n   * @deprecated Since v6. Use @Security from @tsed/schema\n   */\n  security?:\n    | {\n        [securityName: string]: string[];\n      }[]\n    | {\n        [securityName: string]: string[];\n      };\n\n  [key: string]: any;\n}\n\n/**\n * Change authentication options.\n *\n * ```typescript\n * @Controller('/mypath')\n * @UseAuth(MyAuthStrategy, {role: ''})\n * class MyCtrl {\n *\n *   @Get('/')\n *   @AuthOptions(MyAuthStrategy, {role: 'admin'})\n *   public getResource(){}\n * }\n * ```\n *\n * @param guardAuth\n * @param options {Object} Object passed to the customer auth strategy\n * @returns {Function}\n * @decorator\n * @decorator\n * @operation\n */\nexport function AuthOptions(guardAuth: Type<any>, options: IAuthOptions = {}): Function {\n  return <T>(...args: DecoratorParameters): TypedPropertyDescriptor<T> | void => {\n    switch (decoratorTypeOf(args)) {\n      case DecoratorTypes.METHOD:\n        return JsonEntityFn((entity) => {\n          const store = entity.store;\n\n          if (options.responses) {\n            const {responses} = options;\n            store.merge(\"responses\", responses, true);\n            delete options.responses;\n          }\n\n          if (options.security) {\n            const {security} = options;\n            [].concat(security as any).forEach((security) => {\n              Object.entries(security).forEach(([name, scopes]: [string, string[]]) => {\n                entity.operation!.addSecurityScopes(name, scopes);\n              });\n            });\n\n            delete options.security;\n          }\n\n          store.merge(guardAuth, options, true);\n        })(...(args as DecoratorMethodParameters));\n\n      case DecoratorTypes.CLASS:\n        decorateMethodsOf(args[0], AuthOptions(guardAuth, options));\n        break;\n\n      default:\n        throw new UnsupportedDecoratorType(AuthOptions, args);\n    }\n  };\n}\n"]}